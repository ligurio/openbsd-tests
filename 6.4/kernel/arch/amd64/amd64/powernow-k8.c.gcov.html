<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - 6.4 - arch/amd64/amd64/powernow-k8.c</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">arch/amd64/amd64</a> - powernow-k8.c<span style="font-size: 80%;"> (source / <a href="powernow-k8.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">6.4</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">191</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2018-10-19 03:25:38</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">9</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*      $OpenBSD: powernow-k8.c,v 1.28 2018/01/14 00:33:09 bluhm Exp $ */</a>
<span class="lineNum">       2 </span>            : /*
<span class="lineNum">       3 </span>            :  * Copyright (c) 2004 Martin Végiard.
<span class="lineNum">       4 </span>            :  * Copyright (c) 2004-2005 Bruno Ducrot
<span class="lineNum">       5 </span>            :  * Copyright (c) 2004 FUKUDA Nobuhiko &lt;nfukuda@spa.is.uec.ac.jp&gt;
<span class="lineNum">       6 </span>            :  *
<span class="lineNum">       7 </span>            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">       8 </span>            :  * modification, are permitted provided that the following conditions
<span class="lineNum">       9 </span>            :  * are met:
<span class="lineNum">      10 </span>            :  * 1. Redistributions of source code must retain the above copyright
<span class="lineNum">      11 </span>            :  *    notice, this list of conditions and the following disclaimer.
<span class="lineNum">      12 </span>            :  * 2. Redistributions in binary form must reproduce the above copyright
<span class="lineNum">      13 </span>            :  *    notice, this list of conditions and the following disclaimer in the
<span class="lineNum">      14 </span>            :  *    documentation and/or other materials provided with the distribution.
<span class="lineNum">      15 </span>            :  *
<span class="lineNum">      16 </span>            :  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
<span class="lineNum">      17 </span>            :  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<span class="lineNum">      18 </span>            :  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
<span class="lineNum">      19 </span>            :  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
<span class="lineNum">      20 </span>            :  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
<span class="lineNum">      21 </span>            :  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
<span class="lineNum">      22 </span>            :  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
<span class="lineNum">      23 </span>            :  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
<span class="lineNum">      24 </span>            :  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
<span class="lineNum">      25 </span>            :  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">      26 </span>            :  */
<span class="lineNum">      27 </span>            : /* AMD POWERNOW K8 driver */
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #include &lt;sys/param.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;sys/systm.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;sys/malloc.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;sys/sysctl.h&gt;
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : #include &lt;dev/isa/isareg.h&gt;
<span class="lineNum">      35 </span>            : #include &lt;amd64/include/isa_machdep.h&gt;
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #include &lt;machine/cpu.h&gt;
<span class="lineNum">      38 </span>            : #include &lt;machine/cpufunc.h&gt;
<span class="lineNum">      39 </span>            : #include &lt;machine/bus.h&gt;
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : #include &quot;acpicpu.h&quot;
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : #if NACPICPU &gt; 0
<span class="lineNum">      44 </span>            : #include &lt;dev/acpi/acpidev.h&gt;
<span class="lineNum">      45 </span>            : #endif
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            : #define BIOS_START                      0xe0000
<span class="lineNum">      48 </span>            : #define BIOS_LEN                        0x20000
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span>            : extern int setperf_prio;
<span class="lineNum">      51 </span>            : extern int perflevel;
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : /*
<span class="lineNum">      54 </span>            :  * MSRs and bits used by PowerNow technology
<span class="lineNum">      55 </span>            :  */
<span class="lineNum">      56 </span>            : #define MSR_AMDK7_FIDVID_CTL            0xc0010041
<span class="lineNum">      57 </span>            : #define MSR_AMDK7_FIDVID_STATUS         0xc0010042
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            : /* Bitfields used by K8 */
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : #define PN8_CTR_FID(x)                  ((x) &amp; 0x3f)
<span class="lineNum">      62 </span>            : #define PN8_CTR_VID(x)                  (((x) &amp; 0x1f) &lt;&lt; 8)
<span class="lineNum">      63 </span>            : #define PN8_CTR_PENDING(x)              (((x) &amp; 1) &lt;&lt; 32)
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span>            : #define PN8_STA_CFID(x)                 ((x) &amp; 0x3f)
<span class="lineNum">      66 </span>            : #define PN8_STA_SFID(x)                 (((x) &gt;&gt; 8) &amp; 0x3f)
<span class="lineNum">      67 </span>            : #define PN8_STA_MFID(x)                 (((x) &gt;&gt; 16) &amp; 0x3f)
<span class="lineNum">      68 </span>            : #define PN8_STA_PENDING(x)              (((x) &gt;&gt; 31) &amp; 0x01)
<span class="lineNum">      69 </span>            : #define PN8_STA_CVID(x)                 (((x) &gt;&gt; 32) &amp; 0x1f)
<span class="lineNum">      70 </span>            : #define PN8_STA_SVID(x)                 (((x) &gt;&gt; 40) &amp; 0x1f)
<span class="lineNum">      71 </span>            : #define PN8_STA_MVID(x)                 (((x) &gt;&gt; 48) &amp; 0x1f)
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span>            : /* Reserved1 to PowerNow K8 configuration */
<span class="lineNum">      74 </span>            : #define PN8_PSB_TO_RVO(x)               ((x) &amp; 0x03)
<span class="lineNum">      75 </span>            : #define PN8_PSB_TO_IRT(x)               (((x) &gt;&gt; 2) &amp; 0x03)
<span class="lineNum">      76 </span>            : #define PN8_PSB_TO_MVS(x)               (((x) &gt;&gt; 4) &amp; 0x03)
<span class="lineNum">      77 </span>            : #define PN8_PSB_TO_BATT(x)              (((x) &gt;&gt; 6) &amp; 0x03)
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span>            : /* ACPI ctr_val status register to PowerNow K8 configuration */
<span class="lineNum">      80 </span>            : #define PN8_ACPI_CTRL_TO_FID(x)         ((x) &amp; 0x3f)
<span class="lineNum">      81 </span>            : #define PN8_ACPI_CTRL_TO_VID(x)         (((x) &gt;&gt; 6) &amp; 0x1f)
<span class="lineNum">      82 </span>            : #define PN8_ACPI_CTRL_TO_VST(x)         (((x) &gt;&gt; 11) &amp; 0x1f)
<span class="lineNum">      83 </span>            : #define PN8_ACPI_CTRL_TO_MVS(x)         (((x) &gt;&gt; 18) &amp; 0x03)
<span class="lineNum">      84 </span>            : #define PN8_ACPI_CTRL_TO_PLL(x)         (((x) &gt;&gt; 20) &amp; 0x7f)
<span class="lineNum">      85 </span>            : #define PN8_ACPI_CTRL_TO_RVO(x)         (((x) &gt;&gt; 28) &amp; 0x03)
<span class="lineNum">      86 </span>            : #define PN8_ACPI_CTRL_TO_IRT(x)         (((x) &gt;&gt; 30) &amp; 0x03)
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            : #define PN8_PSS_CFID(x)                 ((x) &amp; 0x3f)
<span class="lineNum">      89 </span>            : #define PN8_PSS_CVID(x)                 (((x) &gt;&gt; 6) &amp; 0x1f)
<span class="lineNum">      90 </span>            : 
<span class="lineNum">      91 </span>            : #define WRITE_FIDVID(fid, vid, ctrl)    \
<span class="lineNum">      92 </span>            :         wrmsr(MSR_AMDK7_FIDVID_CTL,     \
<span class="lineNum">      93 </span>            :             (((ctrl) &lt;&lt; 32) | (1ULL &lt;&lt; 16) | ((vid) &lt;&lt; 8) | (fid)))
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            : #define COUNT_OFF_IRT(irt)      DELAY(10 * (1 &lt;&lt; (irt)))
<span class="lineNum">      97 </span>            : #define COUNT_OFF_VST(vst)      DELAY(20 * (vst))
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span>            : #define FID_TO_VCO_FID(fid)     \
<span class="lineNum">     100 </span>            :         (((fid) &lt; 8) ? (8 + ((fid) &lt;&lt; 1)) : (fid))
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span>            : #define POWERNOW_MAX_STATES             16
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span>            : struct k8pnow_state {
<span class="lineNum">     105 </span>            :         int freq;
<span class="lineNum">     106 </span>            :         uint8_t fid;
<span class="lineNum">     107 </span>            :         uint8_t vid;
<span class="lineNum">     108 </span>            : };
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span>            : struct k8pnow_cpu_state {
<span class="lineNum">     111 </span>            :         struct k8pnow_state state_table[POWERNOW_MAX_STATES];
<span class="lineNum">     112 </span>            :         unsigned int n_states;
<span class="lineNum">     113 </span>            :         unsigned int sgtc;
<span class="lineNum">     114 </span>            :         unsigned int vst;
<span class="lineNum">     115 </span>            :         unsigned int mvs;
<span class="lineNum">     116 </span>            :         unsigned int pll;
<span class="lineNum">     117 </span>            :         unsigned int rvo;
<span class="lineNum">     118 </span>            :         unsigned int irt;
<span class="lineNum">     119 </span>            :         int low;
<span class="lineNum">     120 </span>            : };
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span>            : struct psb_s {
<span class="lineNum">     123 </span>            :         char signature[10];     /* AMDK7PNOW! */
<span class="lineNum">     124 </span>            :         uint8_t version;
<span class="lineNum">     125 </span>            :         uint8_t flags;
<span class="lineNum">     126 </span>            :         uint16_t ttime;         /* Min Settling time */
<span class="lineNum">     127 </span>            :         uint8_t reserved;
<span class="lineNum">     128 </span>            :         uint8_t n_pst;
<span class="lineNum">     129 </span>            : };
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span>            : struct pst_s {
<span class="lineNum">     132 </span>            :         uint32_t cpuid;
<span class="lineNum">     133 </span>            :         uint8_t pll;
<span class="lineNum">     134 </span>            :         uint8_t fid;
<span class="lineNum">     135 </span>            :         uint8_t vid;
<span class="lineNum">     136 </span>            :         uint8_t n_states;
<span class="lineNum">     137 </span>            : };
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span>            : struct k8pnow_cpu_state *k8pnow_current_state;
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            : int k8pnow_read_pending_wait(uint64_t *);
<span class="lineNum">     142 </span>            : int k8pnow_decode_pst(struct k8pnow_cpu_state *, uint8_t *);
<span class="lineNum">     143 </span>            : int k8pnow_states(struct k8pnow_cpu_state *, uint32_t, unsigned int, unsigned int);
<span class="lineNum">     144 </span>            : void k8pnow_transition(struct k8pnow_cpu_state *e, int);
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span>            : #if NACPICPU &gt; 0
<span class="lineNum">     147 </span>            : int k8pnow_acpi_init(struct k8pnow_cpu_state *, uint64_t);
<span class="lineNum">     148 </span>            : void k8pnow_acpi_pss_changed(struct acpicpu_pss *, int);
<span class="lineNum">     149 </span>            : int k8pnow_acpi_states(struct k8pnow_cpu_state *, struct acpicpu_pss *, int,
<span class="lineNum">     150 </span>            :     uint64_t);
<span class="lineNum">     151 </span>            : #endif
<a name="152"><span class="lineNum">     152 </span>            : </a>
<span class="lineNum">     153 </span>            : int
<span class="lineNum">     154 </span><span class="lineNoCov">          0 : k8pnow_read_pending_wait(uint64_t *status)</span>
<span class="lineNum">     155 </span>            : {
<span class="lineNum">     156 </span>            :         unsigned int i = 100000;
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :         while (i--) {</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :                 *status = rdmsr(MSR_AMDK7_FIDVID_STATUS);</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :                 if (!PN8_STA_PENDING(*status))</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :                         return 0;</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span>            :         }
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :         printf(&quot;k8pnow_read_pending_wait: change pending stuck.\n&quot;);</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 : }</span>
<a name="167"><span class="lineNum">     167 </span>            : </a>
<span class="lineNum">     168 </span>            : void
<span class="lineNum">     169 </span><span class="lineNoCov">          0 : k8_powernow_setperf(int level)</span>
<span class="lineNum">     170 </span>            : {
<span class="lineNum">     171 </span>            :         unsigned int i;
<span class="lineNum">     172 </span>            :         struct k8pnow_cpu_state *cstate;
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :         cstate = k8pnow_current_state;</span>
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :         i = ((level * cstate-&gt;n_states) + 1) / 101;</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :         if (i &gt;= cstate-&gt;n_states)</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :                 i = cstate-&gt;n_states - 1;</span>
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :         k8pnow_transition(cstate, i);</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 : }</span>
<a name="182"><span class="lineNum">     182 </span>            : </a>
<span class="lineNum">     183 </span>            : void
<span class="lineNum">     184 </span><span class="lineNoCov">          0 : k8pnow_transition(struct k8pnow_cpu_state *cstate, int level)</span>
<span class="lineNum">     185 </span>            : {
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :         uint64_t status;</span>
<span class="lineNum">     187 </span>            :         int cfid, cvid, fid = 0, vid = 0;
<span class="lineNum">     188 </span>            :         int rvo;
<span class="lineNum">     189 </span>            :         u_int val;
<span class="lineNum">     190 </span>            : 
<span class="lineNum">     191 </span>            :         /*
<span class="lineNum">     192 </span>            :          * We dont do a k8pnow_read_pending_wait here, need to ensure that the
<span class="lineNum">     193 </span>            :          * change pending bit isn't stuck,
<span class="lineNum">     194 </span>            :          */
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :         status = rdmsr(MSR_AMDK7_FIDVID_STATUS);</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :         if (PN8_STA_PENDING(status))</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :         cfid = PN8_STA_CFID(status);</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :         cvid = PN8_STA_CVID(status);</span>
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :         fid = cstate-&gt;state_table[level].fid;</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :         vid = cstate-&gt;state_table[level].vid;</span>
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :         if (fid == cfid &amp;&amp; vid == cvid)</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span>            :         /*
<span class="lineNum">     208 </span>            :          * Phase 1: Raise core voltage to requested VID if frequency is
<span class="lineNum">     209 </span>            :          * going up.
<span class="lineNum">     210 </span>            :          */
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :         while (cvid &gt; vid) {</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                 val = cvid - (1 &lt;&lt; cstate-&gt;mvs);</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :                 WRITE_FIDVID(cfid, (val &gt; 0) ? val : 0, 1ULL);</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :                 if (k8pnow_read_pending_wait(&amp;status))</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :                 cvid = PN8_STA_CVID(status);</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :                 COUNT_OFF_VST(cstate-&gt;vst);</span>
<span class="lineNum">     218 </span>            :         }
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span>            :         /* ... then raise to voltage + RVO (if required) */
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         for (rvo = cstate-&gt;rvo; rvo &gt; 0 &amp;&amp; cvid &gt; 0; --rvo) {</span>
<span class="lineNum">     222 </span>            :                 /* XXX It's not clear from spec if we have to do that
<span class="lineNum">     223 </span>            :                  * in 0.25 step or in MVS.  Therefore do it as it's done
<span class="lineNum">     224 </span>            :                  * under Linux */
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :                 WRITE_FIDVID(cfid, cvid - 1, 1ULL);</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :                 if (k8pnow_read_pending_wait(&amp;status))</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :                 cvid = PN8_STA_CVID(status);</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :                 COUNT_OFF_VST(cstate-&gt;vst);</span>
<span class="lineNum">     230 </span>            :         }
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span>            :         /* Phase 2: change to requested core frequency */
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :         if (cfid != fid) {</span>
<span class="lineNum">     234 </span>            :                 int vco_fid, vco_cfid;
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :                 vco_fid = FID_TO_VCO_FID(fid);</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :                 vco_cfid = FID_TO_VCO_FID(cfid);</span>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :                 while (abs(vco_fid - vco_cfid) &gt; 2) {</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :                         if (fid &gt; cfid) {</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :                                 if (cfid &gt; 6)</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :                                         val = cfid + 2;</span>
<span class="lineNum">     243 </span>            :                                 else
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :                                         val = FID_TO_VCO_FID(cfid) + 2;</span>
<span class="lineNum">     245 </span>            :                         } else
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :                                 val = cfid - 2;</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :                         WRITE_FIDVID(val, cvid, (uint64_t)cstate-&gt;pll * 1000 / 5);</span>
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :                         if (k8pnow_read_pending_wait(&amp;status))</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :                         cfid = PN8_STA_CFID(status);</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :                         COUNT_OFF_IRT(cstate-&gt;irt);</span>
<span class="lineNum">     253 </span>            : 
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :                         vco_cfid = FID_TO_VCO_FID(cfid);</span>
<span class="lineNum">     255 </span>            :                 }
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :                 WRITE_FIDVID(fid, cvid, (uint64_t) cstate-&gt;pll * 1000 / 5);</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :                 if (k8pnow_read_pending_wait(&amp;status))</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :                 cfid = PN8_STA_CFID(status);</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :                 COUNT_OFF_IRT(cstate-&gt;irt);</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     263 </span>            : 
<span class="lineNum">     264 </span>            :         /* Phase 3: change to requested voltage */
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :         if (cvid != vid) {</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :                 WRITE_FIDVID(cfid, vid, 1ULL);</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :                 if (k8pnow_read_pending_wait(&amp;status))</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :                 cvid = PN8_STA_CVID(status);</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :                 COUNT_OFF_VST(cstate-&gt;vst);</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         if (cfid == fid || cvid == vid)</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :                 cpuspeed = cstate-&gt;state_table[level].freq;</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span>            : /*
<span class="lineNum">     278 </span>            :  * Given a set of pair of fid/vid, and number of performance states,
<span class="lineNum">     279 </span>            :  * compute state_table via an insertion sort.
<a name="280"><span class="lineNum">     280 </span>            :  */</a>
<span class="lineNum">     281 </span>            : int
<span class="lineNum">     282 </span><span class="lineNoCov">          0 : k8pnow_decode_pst(struct k8pnow_cpu_state *cstate, uint8_t *p)</span>
<span class="lineNum">     283 </span>            : {
<span class="lineNum">     284 </span>            :         int i, j, n;
<span class="lineNum">     285 </span>            :         struct k8pnow_state state;
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :         for (n = 0, i = 0; i &lt; cstate-&gt;n_states; i++) {</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :                 state.fid = *p++;</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :                 state.vid = *p++;</span>
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span>            :                 /*
<span class="lineNum">     291 </span>            :                  * The minimum supported frequency per the data sheet is 800MHz
<span class="lineNum">     292 </span>            :                  * The maximum supported frequency is 5000MHz.
<span class="lineNum">     293 </span>            :                  */
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :                 state.freq = 800 + state.fid * 100;</span>
<span class="lineNum">     295 </span>            :                 j = n;
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :                 while (j &gt; 0 &amp;&amp; cstate-&gt;state_table[j - 1].freq &gt; state.freq) {</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :                         memcpy(&amp;cstate-&gt;state_table[j],</span>
<span class="lineNum">     298 </span>            :                             &amp;cstate-&gt;state_table[j - 1],
<span class="lineNum">     299 </span>            :                             sizeof(struct k8pnow_state));
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :                         --j;</span>
<span class="lineNum">     301 </span>            :                 }
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :                 memcpy(&amp;cstate-&gt;state_table[j], &amp;state,</span>
<span class="lineNum">     303 </span>            :                     sizeof(struct k8pnow_state));
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :                 n++;</span>
<span class="lineNum">     305 </span>            :         }
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">     307 </span>            : }
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span>            : #if NACPICPU &gt; 0
<a name="310"><span class="lineNum">     310 </span>            : </a>
<span class="lineNum">     311 </span>            : int
<span class="lineNum">     312 </span><span class="lineNoCov">          0 : k8pnow_acpi_states(struct k8pnow_cpu_state * cstate, struct acpicpu_pss * pss,</span>
<span class="lineNum">     313 </span>            :     int nstates, uint64_t status)
<span class="lineNum">     314 </span>            : {
<span class="lineNum">     315 </span>            :         struct k8pnow_state state;
<span class="lineNum">     316 </span>            :         int j, k, n;
<span class="lineNum">     317 </span>            :         uint32_t ctrl;
<span class="lineNum">     318 </span>            : 
<span class="lineNum">     319 </span>            :         k = -1;
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :         for (n = 0; n &lt; cstate-&gt;n_states; n++) {</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :                 if ((PN8_STA_CFID(status) == PN8_PSS_CFID(pss[n].pss_status)) &amp;&amp;</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :                     (PN8_STA_CVID(status) == PN8_PSS_CVID(pss[n].pss_status)))</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :                         k = n;</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :                 ctrl = pss[n].pss_ctrl;</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :                 state.fid = PN8_ACPI_CTRL_TO_FID(ctrl);</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :                 state.vid = PN8_ACPI_CTRL_TO_VID(ctrl);</span>
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :                 state.freq = pss[n].pss_core_freq;</span>
<span class="lineNum">     330 </span>            :                 j = n;
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :                 while (j &gt; 0 &amp;&amp; cstate-&gt;state_table[j - 1].freq &gt; state.freq) {</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :                         memcpy(&amp;cstate-&gt;state_table[j],</span>
<span class="lineNum">     333 </span>            :                             &amp;cstate-&gt;state_table[j - 1],
<span class="lineNum">     334 </span>            :                             sizeof(struct k8pnow_state));
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :                         --j;</span>
<span class="lineNum">     336 </span>            :                 }
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                 memcpy(&amp;cstate-&gt;state_table[j], &amp;state,</span>
<span class="lineNum">     338 </span>            :                     sizeof(struct k8pnow_state));
<span class="lineNum">     339 </span>            :         }
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :         return k;</span>
<span class="lineNum">     342 </span>            : }
<a name="343"><span class="lineNum">     343 </span>            : </a>
<span class="lineNum">     344 </span>            : void
<span class="lineNum">     345 </span><span class="lineNoCov">          0 : k8pnow_acpi_pss_changed(struct acpicpu_pss * pss, int npss)</span>
<span class="lineNum">     346 </span>            : {
<span class="lineNum">     347 </span>            :         int curs, needtran;
<span class="lineNum">     348 </span>            :         struct k8pnow_cpu_state *cstate, *nstate;
<span class="lineNum">     349 </span>            :         uint32_t ctrl;
<span class="lineNum">     350 </span>            :         uint64_t status;
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :         status = rdmsr(MSR_AMDK7_FIDVID_STATUS);</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :         cstate = k8pnow_current_state;</span>
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :         nstate = malloc(sizeof(struct k8pnow_cpu_state), M_DEVBUF, M_NOWAIT);</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :         if (!nstate)</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :         curs = k8pnow_acpi_states(nstate, pss, npss, status);</span>
<span class="lineNum">     360 </span>            :         needtran = 0;
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :         if (curs &lt; 0) {</span>
<span class="lineNum">     363 </span>            :                 /* Our current opearting state is not among the ones found the new PSS */
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :                 curs = ((perflevel * npss) + 1) / 101;</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :                 if (curs &gt;= npss)</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :                         curs = npss - 1;</span>
<span class="lineNum">     367 </span>            :                 needtran = 1;
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :         ctrl = pss[curs].pss_ctrl;</span>
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :         nstate-&gt;rvo = PN8_ACPI_CTRL_TO_RVO(ctrl);</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :         nstate-&gt;vst = PN8_ACPI_CTRL_TO_VST(ctrl);</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :         nstate-&gt;mvs = PN8_ACPI_CTRL_TO_MVS(ctrl);</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :         nstate-&gt;pll = PN8_ACPI_CTRL_TO_PLL(ctrl);</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :         nstate-&gt;irt = PN8_ACPI_CTRL_TO_IRT(ctrl);</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :         nstate-&gt;low = 0;</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :         nstate-&gt;n_states = npss;</span>
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :         if (needtran)</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :                 k8pnow_transition(nstate, curs);</span>
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :         free(cstate, M_DEVBUF, sizeof(*cstate));</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :         k8pnow_current_state = nstate;</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 : }</span>
<a name="386"><span class="lineNum">     386 </span>            : </a>
<span class="lineNum">     387 </span>            : int
<span class="lineNum">     388 </span><span class="lineNoCov">          0 : k8pnow_acpi_init(struct k8pnow_cpu_state * cstate, uint64_t status)</span>
<span class="lineNum">     389 </span>            : {
<span class="lineNum">     390 </span>            :         int curs;
<span class="lineNum">     391 </span>            :         uint32_t ctrl;
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :         struct acpicpu_pss *pss;</span>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :         cstate-&gt;n_states = acpicpu_fetch_pss(&amp;pss);</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         if (cstate-&gt;n_states == 0)</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :         acpicpu_set_notify(k8pnow_acpi_pss_changed);</span>
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         curs = k8pnow_acpi_states(cstate, pss, cstate-&gt;n_states, status);</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :         ctrl = pss[curs].pss_ctrl;</span>
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :         cstate-&gt;rvo = PN8_ACPI_CTRL_TO_RVO(ctrl);</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :         cstate-&gt;vst = PN8_ACPI_CTRL_TO_VST(ctrl);</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :         cstate-&gt;mvs = PN8_ACPI_CTRL_TO_MVS(ctrl);</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :         cstate-&gt;pll = PN8_ACPI_CTRL_TO_PLL(ctrl);</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :         cstate-&gt;irt = PN8_ACPI_CTRL_TO_IRT(ctrl);</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :         cstate-&gt;low = 0;</span>
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span>            : #endif /* NACPICPU */
<a name="413"><span class="lineNum">     413 </span>            : </a>
<span class="lineNum">     414 </span>            : int
<span class="lineNum">     415 </span><span class="lineNoCov">          0 : k8pnow_states(struct k8pnow_cpu_state *cstate, uint32_t cpusig,</span>
<span class="lineNum">     416 </span>            :     unsigned int fid, unsigned int vid)
<span class="lineNum">     417 </span>            : {
<span class="lineNum">     418 </span>            :         struct psb_s *psb;
<span class="lineNum">     419 </span>            :         struct pst_s *pst;
<span class="lineNum">     420 </span>            :         uint8_t *p;
<span class="lineNum">     421 </span>            :         int i;
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :         for (p = (u_int8_t *)ISA_HOLE_VADDR(BIOS_START);</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :             p &lt; (u_int8_t *)ISA_HOLE_VADDR(BIOS_START + BIOS_LEN); p += 16) {</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :                 if (memcmp(p, &quot;AMDK7PNOW!&quot;, 10) == 0) {</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :                         psb = (struct psb_s *)p;</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :                         if (psb-&gt;version != 0x14)</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :                                 return 0;</span>
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :                         cstate-&gt;vst = psb-&gt;ttime;</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :                         cstate-&gt;rvo = PN8_PSB_TO_RVO(psb-&gt;reserved);</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :                         cstate-&gt;irt = PN8_PSB_TO_IRT(psb-&gt;reserved);</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :                         cstate-&gt;mvs = PN8_PSB_TO_MVS(psb-&gt;reserved);</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :                         cstate-&gt;low = PN8_PSB_TO_BATT(psb-&gt;reserved);</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :                         p+= sizeof(struct psb_s);</span>
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                         for(i = 0; i &lt; psb-&gt;n_pst; ++i) {</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :                                 pst = (struct pst_s *) p;</span>
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :                                 cstate-&gt;pll = pst-&gt;pll;</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :                                 cstate-&gt;n_states = pst-&gt;n_states;</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :                                 if (cpusig == pst-&gt;cpuid &amp;&amp;</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :                                     pst-&gt;fid == fid &amp;&amp; pst-&gt;vid == vid) {</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :                                         return (k8pnow_decode_pst(cstate,</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :                                             p+= sizeof (struct pst_s)));</span>
<span class="lineNum">     446 </span>            :                                 }
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :                                 p += sizeof(struct pst_s) + 2</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :                                     * cstate-&gt;n_states;</span>
<span class="lineNum">     449 </span>            :                         }
<span class="lineNum">     450 </span>            :                 }
<span class="lineNum">     451 </span>            :         }
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span><span class="lineNoCov">          0 : }</span>
<a name="456"><span class="lineNum">     456 </span>            : </a>
<span class="lineNum">     457 </span>            : void
<span class="lineNum">     458 </span><span class="lineNoCov">          0 : k8_powernow_init(struct cpu_info *ci)</span>
<span class="lineNum">     459 </span>            : {
<span class="lineNum">     460 </span>            :         uint64_t status;
<span class="lineNum">     461 </span>            :         u_int maxfid, maxvid, i;
<span class="lineNum">     462 </span>            :         u_int32_t extcpuid, dummy;
<span class="lineNum">     463 </span>            :         struct k8pnow_cpu_state *cstate;
<span class="lineNum">     464 </span>            :         struct k8pnow_state *state;
<span class="lineNum">     465 </span>            :         char * techname = NULL;
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :         if (setperf_prio &gt; 1)</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :         cstate = malloc(sizeof(struct k8pnow_cpu_state), M_DEVBUF, M_NOWAIT);</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :         if (!cstate)</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :         cstate-&gt;n_states = 0;</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :         status = rdmsr(MSR_AMDK7_FIDVID_STATUS);</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :         maxfid = PN8_STA_MFID(status);</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :         maxvid = PN8_STA_MVID(status);</span>
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span>            :         /*
<span class="lineNum">     480 </span>            :         * If start FID is different to max FID, then it is a
<span class="lineNum">     481 </span>            :         * mobile processor.  If not, it is a low powered desktop
<span class="lineNum">     482 </span>            :         * processor.
<span class="lineNum">     483 </span>            :         */
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :         if (PN8_STA_SFID(status) != PN8_STA_MFID(status))</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :                 techname = &quot;PowerNow! K8&quot;;</span>
<span class="lineNum">     486 </span>            :         else
<span class="lineNum">     487 </span>            :                 techname = &quot;Cool'n'Quiet K8&quot;;
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span>            : #if NACPICPU &gt; 0
<span class="lineNum">     490 </span>            :         /* If we have acpi check acpi first */
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :         if (!k8pnow_acpi_init(cstate, status))</span>
<span class="lineNum">     492 </span>            : #endif
<span class="lineNum">     493 </span>            :         {
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :                 if (!k8pnow_states(cstate, ci-&gt;ci_signature, maxfid, maxvid)) {</span>
<span class="lineNum">     495 </span>            :                         /* Extended CPUID signature value */
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                         CPUID(0x80000001, extcpuid, dummy, dummy, dummy);</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                         k8pnow_states(cstate, extcpuid, maxfid, maxvid);</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     499 </span>            :         }
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :         if (cstate-&gt;n_states) {</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :                 printf(&quot;%s: %s %d MHz: speeds:&quot;,</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :                     ci-&gt;ci_dev-&gt;dv_xname, techname, cpuspeed);</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :                 for (i = cstate-&gt;n_states; i &gt; 0; i--) {</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                         state = &amp;cstate-&gt;state_table[i-1];</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                         printf(&quot; %d&quot;, state-&gt;freq);</span>
<span class="lineNum">     506 </span>            :                 }
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :                 printf(&quot; MHz\n&quot;);</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                 k8pnow_current_state = cstate;</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :                 cpu_setperf = k8_powernow_setperf;</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :                 setperf_prio = 1;</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     512 </span>            :         }
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :         free(cstate, M_DEVBUF, sizeof(*cstate));</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
