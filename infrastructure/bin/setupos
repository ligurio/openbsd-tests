#!/bin/sh

# Setup OpenBSD

VERSION="54"
MIRROR="ftp://ftp.eu.openbsd.org/pub/OpenBSD/snapshots/`uname -m`"

in_linux ()
{
	curl $MIRROR/cd$VERSION.iso > /boot/cd$VERSION.iso
	yum install -y syslinux
	cp /usr/share/syslinux/memdisk /boot/
	mv /boot/grub/grub.conf{,_}

	cat > /boot/grub/grub.conf << "EOF"
set default=0
set timeout=5
title "OpenBSD installation"
	kernel /memdisk iso
	initrd /cd$VERSION.iso
EOF
}

in_openbsd ()
{
	if [ -n $PKG_PATH ]; then
		MIRROR=$(grep ^installpath /etc/pkg.conf | sed 's/packages\///g' | awk '{ print $3 }')
	fi
	ftp $MIRROR/bsd.rd -o /bsd.rd
	[ -e /etc/boot.conf ] && mv /etc/boot.conf{,_}
	echo "boot bsd.rd" > /etc/boot.conf
}

if [ `uname` == "Linux" ]; then
	in_linux;
	sync && reboot;
elif [ `uname` == "OpenBSD" ]; then
	in_openbsd;
	#sync && reboot;
else
	echo "No support"
fi
